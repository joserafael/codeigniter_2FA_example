services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.php
    container_name: codeigniter_app
    volumes:
      - ./codeigniter_2FA_example:/var/www/html/codeigniter_2FA_example # Mounts your CodeIgniter project in the subfolder
    working_dir: /var/www/html/codeigniter_2FA_example # Working directory inside the project subfolder
    environment:
      CI_ENVIRONMENT: development
      # MySQL Database
      database.default.hostname: db
      database.default.database: ${MYSQL_DATABASE:-ci4_db}
      database.default.username: ${MYSQL_USER:-user}
      database.default.password: ${MYSQL_PASSWORD:-password}
      database.default.DBDriver: MySQLi
      # Redis (for CodeIgniter cache)
      cache.redis.host: redis
      cache.redis.password: # null or empty if no password
      cache.redis.port: 6379
      cache.redis.timeout: 0
      cache.redis.database: 0 # Default Redis database
      # Email (MailHog)
      email.fromEmail: "app@example.com"
      email.fromName: "codeigniter_project"
      email.SMTPHost: mailhog
      email.SMTPPort: 1025
      email.SMTPUser: "" # MailHog does not require authentication
      email.SMTPPass: ""
      email.protocol: smtp
      email.mailType: html
      email.charset: utf-8
      email.SMTPCrypto: "" # No encryption for MailHog
    depends_on:
      - db
      - redis
    networks:
      - app_network

  nginx:
    image: nginx:alpine
    container_name: codeigniter_nginx
    ports:
      - "${NGINX_HOST_PORT:-8080}:80" # Host port:Container port
    volumes:
      - ./codeigniter_2FA_example:/var/www/html/codeigniter_2FA_example # Nginx also needs access to the project subfolder
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf # Nginx configuration
    depends_on:
      - app
    networks:
      - app_network

  db:
    image: mysql:8.0
    container_name: codeigniter_mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ci4_db}
      MYSQL_USER: ${MYSQL_USER:-user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
    ports:
      - "${MYSQL_HOST_PORT:-33061}:3306" # Host port:Container port
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app_network

  redis:
    image: redis:alpine
    container_name: codeigniter_redis
    restart: unless-stopped
    ports:
      - "${REDIS_HOST_PORT:-63791}:6379" # Host port:Container port
    volumes:
      - redis_data:/data
    networks:
      - app_network

  mailhog:
    image: mailhog/mailhog
    container_name: codeigniter_mailhog
    ports:
      - "1025:1025" # SMTP Port
      - "8025:8025" # Web Interface Port
    networks:
      - app_network

  redis-commander:
    container_name: codeigniter_redis_commander
    hostname: redis-commander
    image: rediscommander/redis-commander:latest
    restart: unless-stopped
    environment:
      - REDIS_HOSTS=local:redis:6379 # Connects to your 'redis' service on port 6379 (Docker internal)
    ports:
      - "8081:8081" # Host port to access Redis Commander : Redis Commander internal port
    networks:
      - app_network

volumes:
  mysql_data:
  redis_data:

networks:
  app_network:
    driver: bridge
