# CodeIgniter 4 2FA API Example

This is a robust example of a Two-Factor Authentication (2FA) implementation in a CodeIgniter 4 API, utilizing the `spomky-labs/otphp` library for Time-based One-Time Passwords (TOTP).

## Features

-   **User Login**: Standard email/password authentication.
-   **2FA Setup**: Generates a TOTP secret and QR code (SVG) for authenticator apps (Google Authenticator, Authy, etc.).
-   **2FA Verification**: Verifies the OTP code and enables 2FA for the user.
-   **Secure Storage**: Secrets are stored in the database (this example uses SQLite for simplicity).

## Prerequisites

-   PHP 8.1+
-   Composer

## Installation & Setup

1.  **Install Dependencies**
    ```bash
    composer install
    ```

3.  **Run Migrations**
    The app is configured to use MySQL. If running natively/locally (outside Docker), ensure your MySQL server is running and credentials in `.env` match.
    If using Docker, the `db` service handles this.

    Create the `users` table:
    ```bash
    php spark migrate
    ```

4.  **Seed the Database**
    Create a test user (`test@example.com` / `password`):
    ```bash
    php spark db:seed UserSeeder
    ```

5.  **Start the Server**
    ```bash
    php spark serve
    ```
    The server will start at `http://localhost:8080`.

## API Usage Guide

### 1. Initial Login
Authenticate with the test credentials.

-   **Endpoint**: `POST /auth/login`
-   **Payload**:
    ```json
    {
        "email": "test@example.com",
        "password": "password"
    }
    ```
-   **Response**:
    ```json
    {
        "user_id": 1,
        "email": "test@example.com",
        "is_2fa_enabled": false,
        "message": "Login successful (No 2FA)"
    }
    ```

### 2. Setup 2FA
Generate a secret key and QR code to scan.

-   **Endpoint**: `POST /auth/setup`
-   **Payload**:
    ```json
    {
        "user_id": 1
    }
    ```
-   **Response**: Contains a `secret` (text) and `qr_code_svg` (Base64 encoded SVG image).
    *   **Action**: Scan the QR code with your Authenticator App (e.g., **Google Authenticator**, **Microsoft Authenticator**, or **Authy**).

### 3. Verify & Enable 2FA
Verify the code generated by your Authenticator App to finalize the setup.

-   **Endpoint**: `POST /auth/verify`
-   **Payload**:
    ```json
    {
        "user_id": 1,
        "code": "123456" // Replace with code from app
    }
    ```
-   **Response**:
    ```json
    {
        "status": "success",
        "message": "2FA Verified and Enabled! Login complete."
    }
    ```

### 4. Login with 2FA Enabled
Now when you login, the system detects 2FA is active.

-   **Endpoint**: `POST /auth/login`
-   **Payload**:
    ```json
    {
        "email": "test@example.com",
        "password": "password"
    }
    ```
-   **Response**:
    ```json
    {
        "user_id": 1,
        "is_2fa_enabled": true,
        "message": "2FA required. Please call /auth/verify with your code."
    }
    ```
    *Note: In a real application, you would now call a verify endpoint (similar to step 3, but purely for authentication) to get your final access token.*

## Dependencies

-   `codeigniter4/framework`
-   `spomky-labs/otphp`: TOTP generation and verification.
-   `bacon/bacon-qr-code`: QR Code generation.
